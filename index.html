<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>BETA - TRP - Translink</title>

        <link rel="stylesheet" type="text/css" href="lib/dialog-polyfill/dialog-polyfill.css"/>
        <script src="lib/dialog-polyfill/dialog-polyfill.js"></script>

        <script src="lib/smk.js"></script>

        <style>
            body.hide {
                visibility: hidden;
            }
        </style>

        <link rel="stylesheet" type="text/css" href="article.css"/>       
        <link rel="stylesheet" type="text/css" href="splash-dialog.css"/>       
    </head>
    
    <body class="hide">
        <article>
            <dialog id="disclaimer">
                <form method="dialog">
                    <header>
                        <h1><span class="translink-logo"></span>Truck Route Planner</h1>
                    </header>

                    <section>
                        <p>
                            This website (the Truck Route Planner (TRP) Beta) and all of the information it contains are provided "as is" without warranty of any kind, whether express or implied. 
                            All implied warranties, including, without limitation, implied warranties of merchantability, fitness for a particular purpose, and non-infringement, are hereby expressly disclaimed.
                        </p>
                        <p>
                            Links and references to any other websites are provided for information only and listing shall not be taken as endorsement of any kind. 
                            TransLink is not responsible for the content or reliability of the linked websites and does not endorse the content, products, services or views expressed within them.
                        </p>
                        <p>
                            Under no circumstances will TransLink be liable to any person or business entity for any direct, indirect, special, incidental, consequential, or other damage based on any use of this website or any other website to which this site is linked, including, without limitation, any lost profits, business interruption, or loss of programs or information, even if TransLink has been specifically advised.
                        </p>
                        <img src="images/no_mobile_icon.svg" class="warningImage" alt="Graphic warning to discourage using mobile devices">
                        <p>
                            <em>This website is intended to be used as a pre-trip planner. Do not operate a vehicle while using this website.</em>
                        </p>
                        <p>
                            By proceeding, you are accepting this disclaimer, and you are indicating you understand the limitations of this website.
                        </p>
                    </section>

                    <menu>
                        <button type="submit" class="acceptButton">I accept the disclaimer and understand the limitations of this website</button>
                    </menu>
                </form>
            </dialog>

            <header>
                <h1><span class="translink-logo"></span>Truck Route Planner</h1>
                <h2>Beta
                    <span class="version">version: 0.0.13</span>
                    <span class="date">built: 2020-02-12</span>
                </h2>
            </header>

            <div id="smk-map-frame"></div>
        </article>
       
        <iframe id="print-holder" style="position: absolute; left: 0; top: 0; visibility: hidden;"></iframe>

        <style>
            .truck-options {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                flex-grow: 1;
            }

            .truck-options .truck-image {
                background-position: center;
                background-repeat: no-repeat;
                background-size: contain;
                height: 50px;
                margin-top: 10px;
                flex-basis: 100%;
            }

            .truck-options .smk-enter-input.truck-type {
                flex-grow: 1;
            }

            .truck-options .smk-enter-input.truck-axles {
                flex-basis: unset;
            }

            .truck-options .smk-enter-input .smk-input select {
                flex-grow: 1;
                border-radius: 6px;
            }

        </style>

        <template id="truck-selection">
            <div class="truck-options">
                <div class="truck-image" v-bind:style="vehicleStyle"></div>
                <div class="smk-enter-input truck-type">
                    <label id="truck-type">Vehicle Type
                        <div class="smk-input">
                            <select
                                v-on:change="selectVehicle( $event.target.value )"
                            >
                                <option
                                    v-for="vehicle, i in vehicleTypes"
                                    v-bind:value="i"
                                    v-bind:selected="vehicleIndex == i"
                                >{{ vehicle.title }}</option>
                            </select>
                        </div>
                    </label>
                </div>
                <div class="smk-enter-input truck-axles">
                    <label id="truck-axles">Axles
                        <div class="smk-input">
                            <select
                                v-if="vehicleIndex != null"
                                v-on:change="selectConfig( $event.target.value )"
                            >
                                <option
                                    v-for="config, i in vehicleTypes[ vehicleIndex ].configs"
                                    v-bind:value="i"
                                    v-bind:selected="configIndex == i"
                                >{{ config.axles }}</option>
                            </select>
                        </div>
                    </label>
                </div>
            </div>
        </template>

        <template id="truck-definition-by-municipality">
            <div v-if="municipalities.length > 0">
                <p>
                    Based on the GVW and axle count, your vehicle is not considered to be a heavy truck in the following municipalities: 
                </p>
                <ul class="municipalities">
                    <li v-for="muni in municipalities">{{ muni }}</li>
                </ul> 
                <p>
                    The driver and/or carrier is responsible for ensuring the default vehicle parameters or user-entered vehicle parameters are an accurate representation of the actual vehicle, for verifying all clearances and restrictions on the route, and for ensuring the vehicle is operated in compliance with all applicable municipal bylaws and provincial and federal regulations. 
                    <a href="[LINK to Municipal and Provincial contact information]">LINK to Municipal and Provincial contact information</a>
                </p>
            </div>
        </template>
    </body>

    <script src="trp-vehicle-definitions.js"></script>

    <script>
        var dialog = document.getElementById( 'disclaimer' )
        dialogPolyfill.registerDialog(dialog)
        dialog.showModal()

        var defaultVehicle = TRP.vehicleTypes[ 0 ].configs[ 0 ]

        SMK.INIT( {
            'smk-container-sel': "#smk-map-frame",
            'smk-config': [ 
                './layers/cardlock/config.json',
                './layers/dangerous-goods-routes/config.json',
                './layers/downtown-vancouver/config.json',
                './layers/industrial-area/config.json',
                './layers/inspection-station/config.json',
                './layers/major-road-network/config.json',
                './layers/metro-vancouver-boundary/config.json',
                './layers/overhead-directional-signs/config.json',
                './layers/overhead-structure-with-height-marker/config.json',
                './layers/overhead-structure-without-height-marker/config.json',
                './layers/oversize-overweight-truck-routes-oah-up-to-4-88-m/config.json',
                './layers/oversize-overweight-truck-routes-oaw-up-to-5-m/config.json',
                './layers/oversize-overweight-truck-routes-gvw-up-to-80000-kg/config.json',
                './layers/oversize-overweight-truck-routes-gvw-up-to-85000-kg/config.json',
                './layers/oversize-overweight-truck-routes-gvw-up-to-125000-kg/config.json',
                './layers/port-of-vancouver-facilities-terminals/config.json',
                './layers/provincial-highway/config.json',
                './layers/term-permit-oaw-over-3-2-m/config.json',
                './layers/term-permit-oaw-over-3-8-m/config.json',
                './layers/term-permit-os-ow-truck-restriction/config.json',
                './layers/term-permit-roundabout/config.json',
                './layers/truck-advisories-restrictions/config.json',
                './layers/truck-advisories-warning/config.json',
                './layers/truck-parking/config.json',
                './layers/truck-routes-designated-municipal-truck-route-with-restrictions/config.json',
                './layers/truck-routes-designated-municipal-truck-route/config.json',
                './layers/truck-routes-federal-road-with-no-truck-travel-restrictions/config.json',
                './layers/truck-routes-municipal-road-with-no-truck-travel-restriction/config.json',

                './config/map.json', 
                './config/layer-display.json', 
                {
                    tools: [ {
                        type: 'directions',
                        truckHeight: defaultVehicle.height,
                        truckWidth: defaultVehicle.width,
                        truckLength: defaultVehicle.length,
                        truckWeight: defaultVehicle.weight,
                    } ]
                },
                '?' 
            ],
        } ).then( function () {
            $( 'body' ).addClass( 'device-' + SMK.MAP[ 1 ].$device )

            SMK.HANDLER.set( 'bespoke--feedback', 'initialized', function ( smk ) {} )

            SMK.HANDLER.set( 'bespoke--feedback', 'activated', function ( smk, tool, el ) {
                include( [ { url: './fragments/feedback.html' }, { url: './fragments/feedback.css' } ], 'bespoke--feedback' ).then( function ( inc ) {
                    el.innerHTML = inc[ 'bespoke--feedback.feedback-html' ]
                } ) 
            } )

            SMK.HANDLER.set( 'directions-route', 'print', function ( smk, tool, key, opt ) {
                if ( opt.debug ) {
                    window.open( 'print-directions-portrait.html?' + key, '', [
                        "location=yes",
                        "menubar=yes",
                        "titlebar=yes",
                        "status=yes",
                        "toolbar=yes",
                        "scrollbars=yes",
                    ].join( ',' ) );
                }
                else {
                    document.getElementById( 'print-holder' ).src = 'print-directions-portrait.html?' + key
                }

                return new Promise( function ( res, rej ) {
                    var handler = function ( ev ) {
                        console.log( ev )
                        if ( ev.data == 'printed' ) {
                            res()
                            window.removeEventListener( 'message', handler )
                        }
                    }

                    window.addEventListener( 'message', handler, false )

                    setTimeout( function () { rej( new Error( 'timeout' ) ) }, 30 * 1000 )
                } )
            } )

            SMK.HANDLER.set( 'directions-options', 'activated', function ( smk, tool, el ) {
                Vue.nextTick( function () {
                    var vm = new Vue( {
                        template: '#truck-selection',
                        el: el,
                        data: {
                            vehicleTypes: JSON.parse( JSON.stringify( TRP.vehicleTypes ) ), 
                            vehicleIndex: null,
                            configIndex: null,
                        },
                        computed: {
                            vehicleStyle: function () {
                                if ( this.vehicleIndex == null ) return
                                return { 
                                    'background-image': 'url( "' + this.vehicleTypes[ this.vehicleIndex ].image + '" )' 
                                }
                            }
                        },
                        methods: {               
                            selectVehicle: function ( vehicleIndex ) {
                                var self = this 

                                this.vehicleIndex = vehicleIndex

                                Vue.nextTick( function () {
                                    var defaultIndex = self.vehicleTypes[ self.vehicleIndex ].configs.findIndex( function ( a ) {
                                        return a.default
                                    } )

                                    if ( defaultIndex == -1 ) return 

                                    self.selectConfig( defaultIndex )
                                } )
                            },

                            selectConfig: function ( configIndex ) {
                                this.configIndex = configIndex
                                
                                var config = this.vehicleTypes[ this.vehicleIndex ].configs[ this.configIndex ]

                                tool.truckHeight = config.height
                                tool.truckWidth = config.width
                                tool.truckLength = config.length
                                tool.truckWeight = config.weight
                                tool.oversize = config.oversize 

                                Vue.nextTick( function () {
                                    smk.$tool[ 'directions' ].findRoute()
                                } )
                            },
                        }
                    } )

                    vm.selectVehicle( 0 )

                    smk.on( tool.id, {
                        'change': function ( ev ) {
                            var config = vm.$data.vehicleTypes[ vm.$data.vehicleIndex ].configs[ vm.$data.configIndex ]

                            tool.oversize = config.oversize 
                                        || config.height < tool.truckHeight
                                        || config.width < tool.truckWidth
                                        || config.length < tool.truckLength
                                        || config.weight < tool.truckWeight
                        }
                    } )
                } )
            } )

            SMK.HANDLER.set( 'directions', 'route', function ( response ) {
                var muni = {}

                response.segments.features.forEach( function ( s ) {
                    if ( s.properties.isTruckRoute && !s.properties.isOversize && !s.properties.isFerry ) {
                        s.properties[ '@layer' ] = '@potential'
                    }
                    else {
                        s.properties[ '@layer' ] = '@unverified'
                    }

                    muni[ s.properties.locality ] = true
                } )
                
                response.notifications.push( {
                    type: 'TruckRestriction',
                    message: htmlTemplate( '#truck-definition-by-municipality', { 
                        municipalities: Object.keys( muni ).filter( function ( m ) { return !TRP.isHeavyTruckInMunicipality( m, response.request.data.weight ) } )
                    } )
                })
            } )

            SMK.HANDLER.set( 'bespoke--about', 'activated', function ( smk, tool, el ) {
                include( [ { url: './fragments/about.html' }, { url: './fragments/about.css' } ], 'bespoke--about' ).then( function ( inc ) {
                    el.innerHTML = inc[ 'bespoke--about.about-html' ]
                } ) 
            } )

            SMK.HANDLER.set( 'bespoke--glossary', 'activated', function ( smk, tool, el ) {
                include( [ { url: './fragments/glossary.html' }, { url: './fragments/glossary.css' } ], 'bespoke--glossary' ).then( function ( inc ) {
                    el.innerHTML = inc[ 'bespoke--glossary.glossary-html' ]
                } ) 
            } )

            SMK.HANDLER.set( 'bespoke--contacts', 'activated', function ( smk, tool, el ) {
                include( [ { url: './fragments/contacts.html' }, { url: './fragments/contacts.css' } ],'bespoke--contacts' ).then( function ( inc ) {
                    el.innerHTML = inc[ 'bespoke--contacts.contacts-html' ]
                } ) 
            } )

            $( 'body' ).removeClass( 'hide' )
        } )

        function htmlTemplate( template, data ) {
            return ( new Vue( { template: template, data: data } ) ).$mount().$el.innerHTML
        }

    </script>


</html>
